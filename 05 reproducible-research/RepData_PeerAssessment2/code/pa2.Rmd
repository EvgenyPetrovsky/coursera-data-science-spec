---
title: "Severe weather events"
output: html_document
---

```{r "initialization", include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# loading libraries
library(ggplot2)
library(dplyr)
library(tidyr)

# initializing constatns
dataurl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
locfile <- "../workdata/input/StormData.csv.bz2"

```

## Synopsis

The basic goal of this assignment is to explore the NOAA Storm Database and answer some basic questions about severe weather events. Questions to be answered:

1. most harmful events with respect to population health
2. events with the greatest economic consequences

We use U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database to find answer to these questions. First we process data in order to have it in a proper shape, then we plot data as graps and finally we reason about it.  

## Data Processing

Data is available in the form of a comma-separated-value [file](`r dataurl`) compressed via the bzip2 algorithm to reduce its size. We download it and store in working folder for further use in our study. 

```{r "load data", cache = TRUE}
if ( !file.exists(locfile)) {
  download.file(dataurl, locfile, method = "curl")
}
dataset <- read.table(locfile, header = T, sep = ",")
```

This dataset is about 500 MB and contains 37 variables. Description is provided by National Weather Service [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf). For our study we need only some of them: let's take `State`, `Date`, `Event Type`, `Fatalities`, `Injuries`, `PropDmg`, `CropDmg`.

```{r "pick attributes", cache = TRUE}
# extract necessary columns
workset <- tbl_df(
  dataset[,c("STATE", "EVTYPE", 
             "FATALITIES", "INJURIES", 
             "PROPDMG", "CROPDMG", 
             "CROPDMGEXP", "PROPDMGEXP",
             "BGN_DATE"
             )]
  ) %>%
  mutate(
    BGN_DATE = as.Date(as.character(BGN_DATE), format = "%m/%d/%Y")
  )
```

Property and Crop damage are do not contain amounts of the same order. So `PROPDMGEXP` and `PROPDMGEXP` which define degree of amount should be considered. possible values are K - thousands, M - millions, B - billions.

``` {r "date and amount", cache = TRUE}
workset <- workset %>%
  # convert date and amount orders (K = 10^3, M - 10^6, B = 10^9)
  mutate(
    PROPDMGEXP = toupper(PROPDMGEXP),
    CROPDMGEXP = toupper(CROPDMGEXP)
  ) %>%
  left_join(
    tbl_df(data.frame(PROPDMGEXP = c('K', 'M', 'B'), prop.ratio = c(1e3, 1e6, 1e9)))
  ) %>%
  left_join(
    tbl_df(data.frame(CROPDMGEXP = c('K', 'M', 'B'), crop.ratio = c(1e3, 1e6, 1e9)))
  ) %>%
  # translate damage into USD
  mutate(
    PROPERTYDAMAGE = PROPDMG * ifelse(is.na(prop.ratio), 1, prop.ratio),
    CROPDAMAGE = CROPDMG * ifelse(is.na(crop.ratio), 1, crop.ratio)
  )
```

For more convenient use in reporting we gather variables into one column VALUE and introduce IMPACT type.

```{r "gather", cache = T}
workset <- workset %>%
  # make it long
  gather(
    key = "IMPACT", 
    value = "VALUE", 
    c(INJURIES, FATALITIES, PROPERTYDAMAGE, CROPDAMAGE)
  ) %>%
  mutate(
    IMPACTTYPE = ifelse(IMPACT %in% c("INJURIES", "FATALITIES"), "HEALTH", "PROPERTY")
  ) %>%
  # keep only useful columns
  select(
    EVTYPE, IMPACTTYPE, IMPACT, VALUE, BGN_DATE
  )
```

Sumarize data: group data by impact and event types. Rank event types by impact; top-5 event types with highest impact will be plotted later.

```{r "top5 selection"}
top5ev <- workset %>%
# group by IMPACT and calc totals
  group_by(
    EVTYPE,
    IMPACTTYPE,
    IMPACT
  ) %>%
  summarise(
    VALUE = sum(VALUE, na.rm = T)
  ) %>%
  group_by(
    IMPACT
  ) %>%
  mutate(
    place = row_number(desc(VALUE))
  ) %>%
  filter(
    place <= 5
  ) %>%
  mutate(
    graphorder = 6 - place
  )
```

For event types that impact health most (#1 in top-5 ranking) take summary by years of observation. 

```{r "summarize by Year and Event Type"}
sumyrtp <- workset %>%
  group_by( 
    EVTYPE, 
    YEAR = as.numeric(format(BGN_DATE, "%Y")), 
    IMPACTTYPE,
    IMPACT 
  ) %>%
  summarize( 
    VALUE = sum(VALUE, na.rm = T) 
  ) %>%
  inner_join(
    subset(top5ev[c("EVTYPE", "IMPACT", "place")], place == 1),
    by = c("EVTYPE" = "EVTYPE", "IMPACT" = "IMPACT")
  )
```


## Results

Plot injuries and fatalities by years 

```{r "plot people health"}
ggplot(
  subset(top5ev, IMPACTTYPE == "HEALTH"),
  aes(x=reorder(EVTYPE, graphorder), y=VALUE/1e3, fill = EVTYPE)
  ) +
  geom_bar(stat='identity', show.legend = F, width = .75) +
  facet_grid(facets = IMPACT ~ .) +
  labs(
    title = "Impact on people health over years",
    x = "Event Type", y = "Thousands of People"
  ) +
  coord_flip()
```

Plot property damage by years 

```{r "plot prop damage"}
ggplot(
  subset(top5ev, IMPACTTYPE == "PROPERTY"),
  aes(x=reorder(EVTYPE, graphorder), y=VALUE/1e9, fill = EVTYPE)
  ) +
  geom_bar(stat='identity', show.legend = F, width = .75) +
  facet_grid(facets = IMPACT ~ .) +
  labs(
    title = "Property damage over years", 
    x = "Event Type", y = "Damage in Billions of US Dollars"
  ) +
  coord_flip()
```

### Tornado consequences over years

Most harmful event types for people health

```{r }
hevtypes <- unique((as.character(sumyrtp[sumyrtp$IMPACTTYPE == "HALTH", ]$EVTYPE)))
top1evtype <- paste(hevtypes, collapse = ", ")
rm("hevtypes")
```

Let's look what were observations for `r top1evtype`.

````{r "plot history"}
ggplot(
  subset(sumyrtp, IMPACTTYPE == "HEALTH"),
  aes(x=YEAR, y=VALUE, fill = EVTYPE)
  ) +
  geom_bar(stat='identity', show.legend = T, width = .75) +
  facet_grid(facets = IMPACT ~ ., scales = "free_y") +
  labs(
    title = "Events damage",
    x = "Year", y = "Number of People"
  )
```


